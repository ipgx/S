#!/usr/bin/env python3
"""
Lake County CMS - Segment GeoJSON Builder
Geocodes each segment's From/To intersections using ArcGIS World Geocoding Service
and builds a GeoJSON FeatureCollection with QA/QC checks.
"""

import csv
import json
import time
import sys
import urllib.request
import urllib.parse
import urllib.error

# Lake County, FL bounding box (with small buffer)
LAKE_COUNTY_BOUNDS = {
    "xmin": -82.05,
    "ymin": 28.35,
    "xmax": -81.20,
    "ymax": 29.10,
}

ARCGIS_GEOCODE_URL = (
    "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"
    "/findAddressCandidates"
)

# Search extent for ArcGIS geocoding to bias toward Lake County
SEARCH_EXTENT = "-82.05,28.35,-81.20,29.10"

GEOCODE_DELAY = 0.25  # seconds between requests


def in_lake_county(lon, lat):
    b = LAKE_COUNTY_BOUNDS
    return b["xmin"] <= lon <= b["xmax"] and b["ymin"] <= lat <= b["ymax"]


def geocode(address):
    """Query ArcGIS World Geocoding Service. Returns (lon, lat, score) or None."""
    params = urllib.parse.urlencode({
        "SingleLine": address,
        "f": "json",
        "outFields": "Match_addr,Addr_type",
        "maxLocations": 1,
        "searchExtent": SEARCH_EXTENT,
        "location": "-81.6,28.7",  # centroid of Lake County
        "distance": 80000,         # 80 km radius
    })
    url = f"{ARCGIS_GEOCODE_URL}?{params}"
    try:
        with urllib.request.urlopen(url, timeout=15) as resp:
            data = json.loads(resp.read())
        candidates = data.get("candidates", [])
        if not candidates:
            return None
        best = candidates[0]
        lon = best["location"]["x"]
        lat = best["location"]["y"]
        score = best.get("score", 0)
        return lon, lat, score
    except Exception as e:
        print(f"  GEOCODE ERROR: {e}")
        return None


def load_segments(csv_text):
    """Parse CSV rows into list of dicts."""
    reader = csv.DictReader(csv_text.splitlines())
    segments = []
    for row in reader:
        segments.append({
            "id":       row["SEGMENT ID"].strip(),
            "road":     row["RoadName"].strip(),
            "from_str": row["From "].strip(),
            "to_str":   row["To"].strip(),
        })
    return segments


def build_address(road, intersection):
    """Format intersection address for geocoding."""
    return f"{road} & {intersection}, Lake County, FL"


def build_geojson(results):
    features = []
    for r in results:
        if r["from_coords"] is None or r["to_coords"] is None:
            continue
        from_lon, from_lat = r["from_coords"]
        to_lon,   to_lat   = r["to_coords"]
        feature = {
            "type": "Feature",
            "properties": {
                "SEGMENT_ID": r["id"],
                "RoadName":   r["road"],
                "From":       r["from_str"],
                "To":         r["to_str"],
                "From_Addr":  r["from_addr"],
                "To_Addr":    r["to_addr"],
                "From_Score": r["from_score"],
                "To_Score":   r["to_score"],
                "QA_Flag":    r["qa_flag"],
            },
            "geometry": {
                "type": "MultiLineString",
                "coordinates": [[[from_lon, from_lat], [to_lon, to_lat]]],
            },
        }
        features.append(feature)
    return {
        "type": "FeatureCollection",
        "name": "Lake_County_CMS",
        "crs": {
            "type": "name",
            "properties": {"name": "urn:ogc:def:crs:OGC:1.3:CRS84"},
        },
        "features": features,
    }


def main():
    csv_data = """\
SEGMENT ID,RoadName,From ,To
1480,8TH ST/OSCEOLA ST/4TH ST/CARROL ST/3R,EAST AVE,W MINNEOLA AVE
10,ABRAMS RD,SR 44,WAYCROSS AVE
20,ANDERSON HILL RD,LAKE SHORE DR,US 27
30,ARDICE AVE,KURT ST,SR 19
40,ARLINGTON AVE,W LADY LAKE BLVD,SOUTH TERMINI
50,AUSTIN MERRITT RD,YOUTH CAMP RD,CR 33
60,BATES AVE,N CENTER ST,CR 44 / DELAND RD
70,BATES AVE,CR 44 / DELAND RD,ESTES RD
80,BAY RD,BAY RD / CR 19A,OLD US 441/ CR 500A
90,BAY RD,OLD US 441/ CR 500A,CR 452/ LAKESHORE DR
100,BLACKSTILL LAKE RD,FOSGATE RD,CR 50
110,BRIDGES RD,SR 33,US 27
120,BRITT RD,SR 44,HORSE RANCH RD
130,BRITT RD,HORSE RANCH RD,WOLF BRANCH RD
1650,CANAL ST,US 441,MAIN ST
1660,CANAL ST,MAIN ST,SR 44
1920,CITRUS GROVE RD,US 27,GRASSY LAKE RD
1670,CITRUS TOWER BLVD,US 27,OAKLEY SEAVER DR
1680,CITRUS TOWER BLVD,OAKLEY SEAVER DR,SR 50
1690,CITRUS TOWER BLVD,SR 50,HOOKS ST
1692,CITRUS TOWER BLVD,HOOKS ST,JOHNS LAKE RD
1695,CITRUS TOWER BLVD,JOHNS LAKE RD,US 27
170,CR 19A,CR 452,CR 44
180,CR 19A,CR 44,SR 19
190,CR 19A,US 441,BAY RD
200,CR 19A,BAY RD / CR 19A,CR 44C/ CR 500A
140,CR 19A (DORA AVE),LAKE DORA DR,CR 500A/ OLD 441
150,CR 19A (DORA AVE),CR 500A/ OLD 441,DAVID WALKER RD
160,CR 19A (DORA AVE),DAVID WALKER RD,US 441
210,CR 25,MARION COUNTY LINE,GRIFFIN AVE
220,CR 25,GRIFFIN AVE,US 27 / US 441
230,CR 25A,US 27/US 441,CR 466A
240,CR 25A,CR 466A,US 27/US 441
250,CR 25A,US 27 (NORTH),US 27 (SOUTH)
280,CR 33,CR 48,BRIDGES RD
290,CR 33,BRIDGES RD,PEBBLE ROCK RD
310,CR 42,MARION COUNTY LINE,SR 19
320,CR 42,SR 19,CR 450
330,CR 42,CR 450,CR 439
340,CR 42,CR 439,CENTRAL AVE
350,CR 42,CENTRAL AVE,PALMETTO ST
360,CR 42,PALMETTO ST,LAKE MACK DR
370,CR 42,LAKE MACK DR,SR 44
380,CR 435,SR 46,DUBSDREAD DR
390,CR 435,DUBSDREAD DR,ORANGE COUNTY LINE
400,CR 437,CR 44A,SR 44
410,CR 437,SR 44,WOLF BRANCH RD
420,CR 437,WOLF BRANCH RD,SR 46
430,CR 437,SR 46,ORANGE COUNTY LINE
440,CR 439,CR 42,CR 44A
450,CR 439,CR 44A,SR 44
460,CR 44,US 441,SILVER LAKE RD
470,CR 44,SILVER LAKE RD,CR 473
480,CR 44,CR 473,APIARY RD
490,CR 44,APIARY RD,CR 452
500,CR 44,CR 452,SR 19
510,CR 44,SR 19,HICKS DITCH RD
520,CR 44,HICKS DITCH RD,CR 44A
530,CR 44,CR 44A,ORANGE AVE
540,CR 44 LEG A,CR 44,US 441
550,CR 445,SR 19,NF 552
560,CR 445,NF 552,CR 445A
570,CR 445A,SR 19,CR 445
580,CR 445A,CR 445,SR 40
590,CR 448,SR 19,CR 561
600,CR 448,CR 561,LAKE INDUSTRIAL BLVD
610,CR 448,LAKE INDUSTRIAL BLVD,ORANGE COUNTY LINE
620,CR 448A,CR 448,CR 48
630,CR 448A,CR 48,SOUTH TERMINI
640,CR 449 (SILVER LAKE),CR 44,MORNINGSIDE DR
650,CR 449 (SILVER LAKE),MORNINGSIDE DR,US 441
670,CR 44A,SKYLINE DR,CR 450A/ CR44A
680,CR 44A,CR 450A,CR 44A
700,CR 44A,CR 44 / DELAND RD,ESTES RD
710,CR 44A,ESTES RD,CR 439
720,CR 44A,CR 439,CR 437
730,CR 44A,CR 437,SR 44
690,CR 44A (GRIFFIN RD),THOMAS RD,US 27/US 441
660,CR 44A (LAKESIDE AVE/ ROSE ST,SR 19,SKYLINE DR
760,CR 44C (EUDORA RD),US 441,CR 500A
770,CR 44C (GRIFFIN RD),CR 468,THOMAS RD
780,CR 450,MARION COUNTY LINE,BABB RD
790,CR 450,BABB RD,SR 19
800,CR 450,SR 19,E UMATILLA BLVD/ W 7TH ST
810,CR 450,E UMATILLA BLVD/ W 7TH ST,CR 42
820,CR 450A,SR 19,CR 44A NORTH
830,CR 452,MARION COUNTY LINE,FELKINS RD
840,CR 452,FELKINS RD,SANDY LANE
850,CR 452,SANDY LANE,LAKE LANDING BLVD
860,CR 452,LAKE LANDING BLVD,CR 44
900,CR 452 (E MAIN ST),ST CLAIR ABRAMS AVE,DORA AVE
870,CR 452 (EUSTIS),CR 44 / CR 452,SR 19
910,CR 452 (LAKE DORA DR),DORA AVE,LAKE AVE
920,CR 452 (LAKESHORE DR),LAKE AVE,BAY RD
930,CR 452 (LAKESHORE DR),BAY RD,OLD US 441 / CR 500A
940,CR 452 (LAKESHORE DR),OLD US 441 / CR 500A,11TH AVE
950,CR 455,SR 19,CR 561
960,CR 455,CR 561,CR 561A
970,CR 455,CR 561A,RIDGEWOOD AVE
980,CR 455,RIDGEWOOD AVE,CR 455/ CR 50
990,CR 455,CR 455 / CR 50,SR 50
1000,CR 46 (SANFORD RD),HIGHLAND ST,US 441
1010,CR 460 (MARTIN LUTHER KING BLVD,THOMAS RD,US 27
1020,CR 466,SUMTER COUNTY LINE RD,ROLLING ACRES RD
1030,CR 466,ROLLING ACRES RD,US 27
1040,CR 466 / LAKE GRIFFIN RD,US 27/ US 441,GRAYS AIRPORT RD
1050,CR 466 / LAKE GRIFFIN RD,GRAYS AIRPORT RD,MARION COUNTY RD
1060,CR 466A,SUMTER COUNTY LINE,TIMBERTOP LN
1065,CR 466A,TIMBERTOP LN,CR 468 / ROSE AVE
1070,CR 466A,CR 468 / ROSE AVE,US 27
1080,CR 466A (PICCIOLA RD),US 27,CR 466B
1090,CR 466A (PICCIOLA RD),CR 466B,COUNTY RD TERMINI
1100,CR 466B,EAGLE NEST RD,CR 466A
1110,CR 468,CR 466A,PINE RIDGE DAIRY RD
1120,CR 468,PINE RIDGE DAIRY RD,GRIFFIN RD
1130,CR 468,GRIFFIN RD,SR 44
1145,CR 46A REALIGNMENT,SR 44,SR 46
1150,CR 470,SUMTER COUNTY LINE,FLORIDA TURNPIKE
1155,CR 470,FLORIDA TURNPIKE,BAY AVE
1160,CR 470,BAY AVE,CR 33
1170,CR 473,CR 44,FOUNTAIN LAKE BLVD
1180,CR 473,FOUNTAIN LAKE BLVD,US 441
1190,CR 474,SR 33,GREEN SWAMP RD
1200,CR 474,GREEN SWAMP RD,US 27
1210,CR 478,SR 19,JAMARLY RD
1220,CR 48,SUMTER COUNTY LINE,CLEARWATER LAKE RD
1225,CR 48,CLEARWATER LAKE RD,CR 33
1230,CR 48,CR 33,HAYWOOD WORM FARM RD
1235,CR 48,HAYWOOD WORM FARM RD,US 27
1240,CR 48,US 27,LIME AVE
1250,CR 48,LIME AVE,SR 19
1260,CR 48,CR 561,RANCH RD
1270,CR 48,RANCH RD,CR 448A
1290,CR 50,US 27,N HANCOCK RD
1300,CR 50,N HANCOCK RD,CR 455
1310,CR 50,CR 455,ORANGE COUNTY LINE
1280,CR 50 (SUNSET AVE),CR 33,SR 50
1380,CR 500A (HIGHLAND ST),5TH AVE,SR 46
1370,CR 500A/ 5TH AVE,OLD 441,N HIGHLAND ST
1320,CR 500A/ OLD 441,SR 19,DORA AVE
1325,CR 500A/ OLD 441,DORA AVE,SR 19
1390,CR 500A/ OLD 441,SR 46,ORANGE COUNTY LINE
1340,CR 500A/OLD 441,BAY RD,CR 44C / EUDORA AVE
1350,CR 500A/OLD 441,CR 44C / EUDORA DR,LAKESHORE DR
1360,CR 500A/OLD 441,LAKESHORE DR,5TH AVE
1330,CR 500A/OLD 441/ALFRED ST,DORA AVE,BAY RD
1400,CR 561,SR 19,CR 448
1410,CR 561,CR 448,CR 48
1420,CR 561,CR 48,SOUTH ASTATULA CITY LIMIT
1430,CR 561,SOUTH ASTATULA CITY LIMIT,CR 455
1440,CR 561,CR 455,HOWEY CROSS RD
1450,CR 561,HOWEY CROSS RD,TURNPIKE RD / CR 561A
1500,CR 561,CR 561A,SR 50
1510,CR 561,SR 50,LOG HOUSE RD
1520,CR 561,LOG HOUSE RD,FLORIDA BOYS RANCH RD
1530,CR 561,FLORIDA BOYS RANCH RD,SR 33
1550,CR 561,W MINNEOLA AVE,CR 565A
1570,CR 561 (LAKE MINNEOLA SHORES),JALARMY RD,US 27
1490,CR 561 (W MINNEOLA AVE),8TH ST,CR 561A
1460,CR 561 / CR 561A,TURNPIKE RD / CR 561A,US 27
1540,CR 561A,TURNPIKE RD / CR 561,SCRUB JAY LN
1545,CR 561A,SCRUB JAY LN,N HANCOCK RD
1546,CR 561A,N HANCOCK RD,CR 455
1560,CR 561A,CR 565A,JALARMY RD
1580,CR 565,US 27,KJELLSTROM LANE
1600,CR 565,SR 50,SLOANS RIDGE
1610,CR 565,SLOANS RIDGE,LAKE ERIE RD
1590,CR 565 (VILLA CITY RD),KJELLSTROM LANE,SR 50
1620,CR 565A,SR 50,CR 561A
1630,CR 565A,SR 50,CR 565B
1640,CR 565B,SR 33,CR 561
1700,DAVID WALKER DR,OLD US 441 / CR 500A,CR 19A
1710,DAVID WALKER DR,CR 19A,US 441
1720,DAVID WALKER DR,US 441,MOUNT HOMER RD
1730,DAVID WALKER DR,MOUNT HOMER RD,FLINKS AVE/KURT AVE
1740,DEAD RIVER RD,WEST TERMINI,SR 19
1750,DONNELLY ST,US 441,11TH AVE
1760,DONNELLY ST,11TH AVE,5TH AVE
1770,DUDA RD,CR 448A,ORANGE COUNTY LINE
2220,E LADY LAKE BLVD,US 27/US441,BERCHFIELD RD
2380,E LAKEVIEW AVE,SR 19,JASMINE ST / CROOKED LAKE CT
2384,E LAKEVIEW AVE,JASMINE ST / CROOKED LAKE CT,HASELTON ST
2460,E MAIN ST,SR 19,CR 452/ ST CLAIR ABRAMS ST
1780,EAGLES NEST RD,US 27,CR 466B
1790,EAST AVE,CR 561,SR 50
1470,EAST AVE/LAKE MINNEOLA DR/MAIN AVE,US 27,EAST AVE
1800,EAST CROOKED LAKE RD,LAKEVIEW DR,BRDVIEW AVE
1810,EAST CROOKED LAKE RD,BRDVIEW AVE,US 441
1820,EMERALDA AVE,EMERALDA ISLAND RD,CR 44
1830,EMPIRE CHURCH RD,CR 565,ANDERSON RD
1840,ESTES RD,CR 44A,LAKE LINCOLN LANE
1850,ESTES RD,LAKE LINCOLN LANE,SR 44
1860,EUDORA RD,OLD MT DORA RD,US 441
1865,EXCALLIBUR RD,HOOKS ST,CITRUS TOWER BLVD
2230,FAIRVIEW AVE,OLD 441/ CR 500A,LAKESHORE DR
1870,FISH CAMP RD,CR 452,CR 44
1880,GOLFLINKS AVE,KURT ST,SR 19 / BAY ST
1890,GOLFLINKS AVE,SR 19 / BAY ST,MARY ST
1900,GOOSE PRAIRIE RD,EMERALDA AVE,CR 452
1910,GRAND HIGHWAY,CITRUS TOWER BLVD,SR 50
1875,GRASSY LAKE RD/FOSGATE RD,CR 50 (WASHINGTON ST),HANCOCK RD
1930,GRAYS AIRPORT RD,MARION COUNTY RD,CR 466
1940,GRAYS AIRPORT RD,CR 466,GRIFFIN VIEW DR
1970,GRIFFIN AVE,US 27 / US 411,CR 25
1980,GRIFFIN AVE,CR 25,UNCLE DONALDS LANE
1990,GRIFFIN AVE,UNCLE DONALDS LANE,GRAYS AIRPORT RD
2000,GRIFFIN RD,US 27,LEE ST
2010,GRIFFIN VIEW DR,US 27,GRAYS AIRPORT RD
2020,GRIFFIN VIEW DR,GRAYS AIRPORT RD,SULEN RD
2030,GROVE ST,SR 19 (BADGER AVE),LAKEVIEW AVE
2040,GROVE ST,LAKEVIEW AVE,GOLFLINKS AVE
2045,GROVE ST,GOLFLINKS AVE,OLD MT DORA RD
2050,HAMMOCK RIDGE,LAKE SHORE DR,US 27
2100,HARTWOOD MARSH RD,US 27,HANCOCK RD
2104,HARTWOOD MARSH RD,HANCOCK RD,N. 90 DEGREE BEND
2110,HARTWOOD MARSH RD,N. 90 DEGREE BEND,ORANGE COUNTY LINE
2120,HASELTON ST,SR 44,LAKEVIEW AVE
2130,HIGHLAND ST,LIMIT AVE,5TH AVE
2140,HOOKS ST,LAKESHORE DR,US 27
2150,HOOKS ST,US 27,OAKLEY SEAVER DR
2153,HOOKS ST,OAKLEY SEAVER DR,CITRUS TOWER BLVD
2155,HOOKS ST,CITRUS TOWER BLVD,HANCOCK RD
2160,HUFFSTETLER DR,DAVID WALKER DR,KURT ST
2170,JALARMY RD,CR 478,CR 561A
2180,JOHNS LAKE RD,US 27,HANCOCK RD
2190,KURT ST,W LAKEVIEW AVE,DAVID WALKER DR
2200,KURT ST,DAVID WALKER DR,MT HOMER RD / W ARDICE AVE
2205,KURT ST,MT HOMER RD / W ARDICE AVE,US 441
2240,LAKE DR,SR 44,COUNTRY RD
2250,LAKE ELLA RD,SUMTER COUNTY LINE,MICRO RACETRACK RD
2254,LAKE ELLA RD,MICRO RACETRACK RD,ROLLING ACRES RD
2255,LAKE ELLA RD,ROLLING ACRES RD,US 27
2260,LAKE ERIE RD,CR 565,SR 33
2270,LAKE EUSTIS DR,US 441,CLAY BLVD
2280,LAKE LOUISA RD,LAKESHORE DR,VISTA DEL LAGO BLVD
2290,LAKE LOUISA RD,VISTA DEL LAGO BLVD,US 27
2300,LAKE MACK DR,CR 42,ANOTHER ANNA RD
2310,LAKE ST,US 441,MAIN ST
2320,LAKE ST,MAIN ST,SR 44
2330,LAKESHORE DR (CLER),CR 561,OSWALT RD
2340,LAKESHORE DR (CLER),OSWALT RD,HARDER RD
2350,LAKESHORE DR (CLER),HARDER RD,LAKE LOUISA RD
2354,LAKESHORE DR (CLER),LAKE LOUISA RD,ANDERSON HILL RD
2360,LAKESHORE DR (EUSTIS),CLAY BLVD,SOUTH BAY ST / SR 19 SB
2390,LANE PARK CUTOFF,SR 19,CR 561
2400,LEE ST,GRIFFIN RD,US 441
2410,LEE ST,US 441,MAIN ST
2430,LIMIT AVE,DONNELLY ST,US 441
2450,LOG HOUSE RD,CR 561,LAKESHORE DR
2440,LONE OAK DR,MAIN ST,SR 44
2470,MAIN ST (LEESBURG),CR 468,THOMAS AVE
2480,MAIN ST (LEESBURG),THOMAS AVE,US 27
2490,MAIN ST (LEESBURG),US 27,LEE ST
2500,MAIN ST (LEESBURG),LEE ST,CANAL ST
2510,MAIN ST (LEESBURG),CANAL ST,LAKE ST
2520,MAIN ST (LEESBURG),LAKE ST,DIXIE AVE / SR 44
2530,MAIN ST (LEESBURG),DIXIE AVE / SR 44,NICHOLS DR / SUNNYSIDE DR
2540,MARION COUNTY RD,CR 25,GRAYS AIRPORT RD
2550,MARION COUNTY RD,GRAYS AIRPORT RD,LAKE GRIFFIN RD
2560,MASCOTTE EMPIRE RD,SR 50,EMPIRE CHURCH RD
2570,McLENDON ST,CLAY AVE,US 27/US441
2580,MICRO RACETRACK RD,LAKE ELLA RD,CR 466A
2590,MORNINGSIDE DR (MOUNT DORA),US 441,CR 500A
2600,MT HOMER RD,CR 19A,US 441
2610,MT HOMER RD,US 441,DAVID WALKER DR
2620,MT HOMER RD,DAVID WALKER DR,KURT ST
2054,N. HANCOCK RD,CR 561A,SR 91 (FLORIDA TURNPIKE)
2055,N. HANCOCK RD,SR 91 (FLORIDA TURNPIKE),OLD HWY 50 (W)
2056,N. HANCOCK RD,OLD HWY 50 (E),OLD HWY 50 (E)
2060,N. HANCOCK RD,OLD HWY 50 (E),N RIDGE BLVD
2070,N. HANCOCK RD,N RIDGE BLVD,SR 50
2630,OLD 441 (CR 500A),US 441,SR 19
2640,OLD EUSTIS RD,MORNINGSIDE DR,E CROOKED LAKE DR
2650,OLD EUSTIS RD,E CROOKED LAKE DR,DONNELLY ST
2660,OLD MOUNT DORA RD,SR 19,EUDORA RD
2670,OLD MOUNT DORA RD,EUDORA RD,US 441
2680,ORANGE AVE,SR 19,HASSELTON ST
2690,ORANGE AVE,HASSELTON ST,ABRAMS RD
2700,OSWALT RD,LAKESHORE DR,EDGEWATER DR
2710,PALMETTO DR,SUNSET AVE,CR 33
2720,PRESCOTT ST,BATES AVE,SR 44
2730,RADIO RD,CR 44,MORNINGSIDE DR
2740,RADIO RD,MORNINGSIDE DR,US 441
2750,ROLLING ACRES RD,US 27 / US 441,OAK ST
2760,ROLLING ACRES RD,OAK ST,CR 466
2770,ROLLING ACRES RD,CR 466,LAKE ELLA RD
2780,ROUND LAKE RD,WOLF BRANCH RD,SR 46
2790,ROUND LAKE RD,SR 46,ORANGE COUNTY LINE
2800,ROYAL TRAILS RD,SEAGRAPE AVE,SR 44
1950,S GRAYS AIRPORT RD,GRIFFIN VIEW DR,EAGLES NEST RD
1960,S GRAYS AIRPORT RD,EAGLES NEST RD,US 27 / US 412
1915,S. GRAND HIGHWAY,SR 50,HOOKS ST
2080,S. HANCOCK RD,SR 50,HOOKS ST
2085,S. HANCOCK RD,HOOKS ST,JOHNS LAKE RD
2090,S. HANCOCK RD,JOHNS LAKE RD,HARTWOOD MARSH RD
2810,SHAY BLVD,TARRSON BLVD,GRIFFIN AVE
2820,SHIRLEY SHORES RD,CR 448,DEER ISLAND RD
2830,SLEEPY HOLLOW RD,US 441,SUNNYSIDE DR
2840,SR 19,MARION COUNTY LINE,CR 445A
2850,SR 19,CR 445A,CR 445
2860,SR 19,CR 445,CR 42
2870,SR 19,CR 42,BAKER RD
2880,SR 19,BAKER RD,CR 450 (UMATILLA BLVD)
2890,SR 19,CR 450 (UMATILLA BLVD),CR 450 (OCALA ST)
2900,SR 19,CR 450 (OCALA ST),CR 450A
2910,SR 19,CR 450A,CR 19A
2920,SR 19,CR 19A,CR 44
2930,SR 19,CR 44,CR 452
2980,SR 19,STEVENS AVE,GOLF LINKS AVE
2990,SR 19,GOLF LINKS AVE,US 441
3010,SR 19,CR 500A/ LAKE SHORE BLVD,CR 452 (MAIN ST)
3020,SR 19,CR 452 (MAIN ST),CR 561
3030,SR 19,CR 561,LANE PARK RD
3040,SR 19,LANE PARK RD,CR 48
3050,SR 19,CR 48,CENTRAL AVE
3060,SR 19,CENTRAL AVE,CR 455
3070,SR 19,CR 455,US 27 / SR 25
3080,SR 19,US 27 / SR 25,CR 478
3090,SR 19,CR 478,LAKE CATHERINE RD
3100,SR 19,LAKE CATHERINE RD,SR 50/ SR 33
3000,SR 19 (DUNCAN DR),US 441,CR 500A/ LAKE SHORE BLVD
2941,SR 19 (N),ORANGE AVE,CR 452
2960,SR 19 (N),STEVENS AVE,ORANGE AVE
2951,SR 19 (S),CR 452,ORANGE AVE
2970,SR 19 (S),ORANGE AVE,STEVENS AVE
3110,SR 33,SR 50/ SR 33,ANDERSON RD
3120,SR 33,ANDERSON RD,CR 565B
3130,SR 33,CR 565B,CR 561
3140,SR 33,CR 561,CR 474
3150,SR 33,CR 474,POLK COUNTY LINE
260,SR 33 / CR 33,US 27,CR 48 /CR 470
300,SR 33 / CR 33,PEBBLE ROCK RD,SR 50
270,SR 33 / SR 48 / CR 33 / CR 48,CR 48 /CR 470,CR 48
3160,SR 40,MARION COUNTY LINE,CR 445A
3170,SR 40,CR 445A,RIVER RD
3180,SR 40,RIVER RD,VOLUSIA COUNTY LINE
3344,SR 429 (WEKIVA PKWY),ORANGE C/L,CR 46A (REALIGNED)
3190,SR 44,SUMTER COUNTY LINE,CR 468
3200,SR 44,CR 468,S LONE OAK DR
3210,SR 44,S LONE OAK DR,US 27
3270,SR 44,ABRAMS RD,THRILL HILL RD
3280,SR 44,THRILL HILL RD,CR 439
3290,SR 44,CR 439,CR 437
3300,SR 44,CR 437,CR 46A
3310,SR 44,CR 46A,CR 44A
3320,SR 44,CR 44A,OVERLOOK DR
3330,SR 44,OVERLOOK DR,CR 42
3340,SR 44,CR 42,VOLUSIA COUNTY LINE
3220,SR 44  (DIXIE AVE),US 27,S 9TH ST
3230,SR 44  (DIXIE AVE),S 9TH ST,CANAL ST
3240,SR 44  (DIXIE AVE),CANAL ST,S LAKE ST
3250,SR 44  (DIXIE AVE),S LAKE ST,E MAIN ST
3260,SR 44  (DIXIE AVE),E MAIN ST,US 441
3262,SR 44 (OLD CR 44B),US 441,WAYCROSS AVE
3268,SR 44 (OLD CR 44B),WAYCROSS AVE,ORANGE AVE
3345,SR 46,CR 46A (REALIGNED),SEMINOLE C/L
3350,SR 46,US 441,VISTA VIEW
3360,SR 46,VISTA VIEW,ROUND LAKE RD
3370,SR 46,ROUND LAKE RD,CR 437 SOUTH
3380,SR 46,CR 437 SOUTH,CR 437 NORTH
3390,SR 46,CR 437 NORTH,CR 435
3395,SR 46,CR 435,CR 46A (REALIGNED)
3420,SR 50,SUMTER COUNTY LINE,CR 565 / BAY LAKE RD
3430,SR 50,CR 565 / BAY LAKE RD,CR 33
3440,SR 50,CR 33,GROVELAND FARMS RD
3450,SR 50,GROVELAND FARMS RD,SR 50 ONE WAY PAIRS
3500,SR 50,SR 33 SOUTH,CR 565A NORTH
3510,SR 50,CR 565A NORTH,CR 561
3520,SR 50,CR 561,EAST AVE
3530,SR 50,EAST AVE,US 27
3540,SR 50,US 27,HANCOCK RD
3550,SR 50,HANCOCK RD,CR 455
3560,SR 50,CR 455,ORANGE COUNTY LINE
3460,SR 50 (E),SR 50 ONE WAY PAIRS,SR 19
3481,SR 50 (E),SR 19,SR 33 SOUTH
3470,SR 50 (W),SR 19,SR 50 ONE WAY PAIRS
3491,SR 50 (W),SR 33 SOUTH,SR 19
3562,SR 91 (FLORIDA TURNPIKE),SUMTER COUNTY LINE,CR 470
3564,SR 91 (FLORIDA TURNPIKE),CR 470,US 27/SR 25
3566,SR 91 (FLORIDA TURNPIKE),US 27/SR 25,US 27/SR 25/SR 19 INTERCHANGE
3568,SR 91 (FLORIDA TURNPIKE),US 27/SR 25/SR 19 INTERCHANGE,ORANGE COUNTY LINE
880,ST CLAIR ABRAMS AVE,US 441,CR 500A
890,ST CLAIR ABRAMS AVE,CR 500A,CR 452 / EAST MAIN ST
3569,STEVES RD,US 27,CITRUS TOWER BLVD
3570,SUNNYSIDE DR,MAIN ST/DR NICHOLS DR,SLEEPY HOLLOW RD
3580,SUNNYSIDE DR,SLEEPY HOLLOW RD,BRIDGEWATER CT
3590,SUNNYSIDE DR,BRIDGEWATER CT,SUNNYSIDE DR
3600,THOMAS AVE,CR 460,CR 44A
3610,THOMAS AVE,GRIFFIN RD (CR 44A),MAIN ST
3620,TURKEY FARM RD,OLD HWY 50,BRIMMING LAKE RD
3630,TUSCANOOGA RD,SUMTER COUNTY LINE,EGG RD
3640,TUSCANOOGA RD,EGG RD,SR 50
3650,UNDERPASS RD,CR 33,AMERICAN LEGION RD
3660,US 192,US 27,ORANGE COUNTY LINE
3760,US 27/SR 25,US 27/US441 SPLIT,MAIN ST
3770,US 27/SR 25,MAIN ST,SR 44
3780,US 27/SR 25,SR 44,CR 25A (NORTH)
3785,US 27/SR 25,CR 25A (NORTH),CR 33
3790,US 27/SR 25,CR 33,CR 48
3800,US 27/SR 25,CR 48,PLANTATION BLVD
3810,US 27/SR 25,PLANTATION BLVD,FLORIDA TURNPIKE
3820,US 27/SR 25,FLORIDA TURNPIKE,SR 19
3830,US 27/SR 25,SR 19,CR 561
3840,US 27/SR 25,CR 561,CR 561A
3850,US 27/SR 25,CR 561A,CR 561/ MAIN AVE
3860,US 27/SR 25,CR 561/ MAIN AVE,CR 50
3870,US 27/SR 25,CR 50,GRAND HIGHWAY
3880,US 27/SR 25,GRAND HIGHWAY,SR 50
3890,US 27/SR 25,SR 50,JOHNS LAKE RD
3900,US 27/SR 25,JOHNS LAKE RD,HARDWOOD MARSH RD
3910,US 27/SR 25,HARDWOOD MARSH RD,LAKE LOUISA RD
3920,US 27/SR 25,LAKE LOUISA RD,BOGGY MARSH RD
3927,US 27/SR 25,BOGGY MARSH RD,CR 474
3930,US 27/SR 25,CR 474,US 192
3670,US 27/US441,SUMTER COUNTY LINE,GRIFFIN AVE
3680,US 27/US441,GRIFFIN AVE,ALT US 441 / ALT US 27
3690,US 27/US441,ALT US 441 / ALT US 27,CR 466
3700,US 27/US441,CR 466,LAKE ELLA RD
3710,US 27/US441,LAKE ELLA RD,CR 466A / MILLER BLVD
3720,US 27/US441,CR 466A / MILLER BLVD,CR 460 (MARTIN LUTHER KING BLVD)
3730,US 27/US441,CR 460 (MARTIN LUTHER KING BLVD),CR 466A (LEE RD)
3740,US 27/US441,CR 466A (LEE RD),CR 44A/ GRIFFIN RD
3750,US 27/US441,CR 44A/ GRIFFIN RD,US 27/US441 SPLIT
3940,US 441/ SR 500,US 27/US441 SPLIT,LEE ST
3950,US 441/ SR 500,LEE ST,N CANAL ST
3960,US 441/ SR 500,N CANAL ST,E DIXIE AVE
3970,US 441/ SR 500,E DIXIE AVE,E MAIN ST
3980,US 441/ SR 500,E MAIN ST,CR 44
3990,US 441/ SR 500,CR 44,RADIO RD
4000,US 441/ SR 500,RADIO RD,CR 473
4010,US 441/ SR 500,CR 473,OLD US 441/ CR 500A
4020,US 441/ SR 500,OLD US 441/ CR 500A,SR 19 / DUNCAN DR
4030,US 441/ SR 500,SR 19 / DUNCAN DR,CR 452 / ST CLAIR ABRAMS AVE
4040,US 441/ SR 500,CR 452 / ST CLAIR ABRAMS AVE,CR 452 / LAKE EUSTIS DR
4050,US 441/ SR 500,CR 452 / LAKE EUSTIS DR,DAVID WALKER DR
4060,US 441/ SR 500,DAVID WALKER DR,SR 19/ BAY ST
4070,US 441/ SR 500,SR 19/ BAY ST,OLD MT DORA RD
4080,US 441/ SR 500,OLD MT DORA RD,DONNELLY ST/SR 44
4090,US 441/ SR 500,DONNELLY ST/SR 44,WOLF BRANCH RD
4100,US 441/ SR 500,WOLF BRANCH RD,SR 46
4110,US 441/ SR 500,SR 46,ORANGE COUNTY LINE
4120,VISTA DEL LAGO BLVD,LAKE LOUISA RD,US 27
2210,W LADY LAKE BLVD,WEST TERMINI,US 27/US441
2370,W LAKEVIEW AVE,KURT ST,SR 19
4130,WASHINGTON AVE,HASELTON ST,ABRAMS RD
4140,WAYCROSS AVE,COUNTY CLUB RD,SR 44 (OLD CR 44B)
4150,WELLS AVE,SR 19,LAKE AVE
2420,WILSON LAKE PARKWAY,US 27,LIBBY RD
4160,WOLF BRANCH RD,US 441,BRITT RD
4170,WOLF BRANCH RD,BRITT RD,CR 437
4180,WOODLEA RD,LANE PARK RD,SR 19
4190,YOUTH CAMP RD,SUMTER COUNTY LINE,AUSTIN MERRITT RD
"""

    segments = load_segments(csv_data)
    total = len(segments)
    print(f"Loaded {total} segments. Starting geocoding...\n")

    results = []
    failed_from = []
    failed_to = []
    out_of_bounds = []
    low_score = []

    for i, seg in enumerate(segments):
        from_addr = build_address(seg["road"], seg["from_str"])
        to_addr   = build_address(seg["road"], seg["to_str"])

        print(f"[{i+1}/{total}] Seg {seg['id']}: {seg['road']}")
        print(f"  FROM: {from_addr}")

        # Geocode FROM
        from_result = geocode(from_addr)
        time.sleep(GEOCODE_DELAY)

        # Geocode TO
        print(f"  TO:   {to_addr}")
        to_result = geocode(to_addr)
        time.sleep(GEOCODE_DELAY)

        qa_flags = []

        # Process FROM
        if from_result is None:
            print(f"  !! FROM geocode FAILED")
            failed_from.append(seg["id"])
            from_coords = None
            from_score = None
        else:
            flon, flat, fscore = from_result
            from_coords = (flon, flat)
            from_score = fscore
            if not in_lake_county(flon, flat):
                print(f"  !! FROM out of bounds: ({flon:.5f}, {flat:.5f})")
                out_of_bounds.append(f"{seg['id']}_FROM")
                qa_flags.append("FROM_OOB")
            if fscore < 80:
                print(f"  !! FROM low score: {fscore}")
                low_score.append(f"{seg['id']}_FROM:{fscore}")
                qa_flags.append(f"FROM_LOW_SCORE:{fscore:.0f}")

        # Process TO
        if to_result is None:
            print(f"  !! TO geocode FAILED")
            failed_to.append(seg["id"])
            to_coords = None
            to_score = None
        else:
            tlon, tlat, tscore = to_result
            to_coords = (tlon, tlat)
            to_score = tscore
            if not in_lake_county(tlon, tlat):
                print(f"  !! TO out of bounds: ({tlon:.5f}, {tlat:.5f})")
                out_of_bounds.append(f"{seg['id']}_TO")
                qa_flags.append("TO_OOB")
            if tscore < 80:
                print(f"  !! TO low score: {tscore}")
                low_score.append(f"{seg['id']}_TO:{tscore}")
                qa_flags.append(f"TO_LOW_SCORE:{tscore:.0f}")

        # Check zero-length segment
        if from_coords and to_coords:
            if abs(from_coords[0] - to_coords[0]) < 1e-6 and \
               abs(from_coords[1] - to_coords[1]) < 1e-6:
                qa_flags.append("ZERO_LENGTH")
                print(f"  !! ZERO LENGTH segment")

        results.append({
            "id":          seg["id"],
            "road":        seg["road"],
            "from_str":    seg["from_str"],
            "to_str":      seg["to_str"],
            "from_addr":   from_addr,
            "to_addr":     to_addr,
            "from_coords": from_coords,
            "to_coords":   to_coords,
            "from_score":  round(from_score, 1) if from_score is not None else None,
            "to_score":    round(to_score, 1)   if to_score   is not None else None,
            "qa_flag":     "; ".join(qa_flags) if qa_flags else "OK",
        })

    # Build GeoJSON
    geojson = build_geojson(results)
    out_path = "/Users/pg/Documents/S/Lake_County_CMS/Lake_County_CMS.geojson"
    with open(out_path, "w") as f:
        json.dump(geojson, f, indent=2)

    # QA/QC Summary
    included = len(geojson["features"])
    skipped  = total - included
    print(f"\n{'='*60}")
    print(f"QA/QC SUMMARY")
    print(f"{'='*60}")
    print(f"Total segments:       {total}")
    print(f"Geocoded (in GeoJSON): {included}")
    print(f"Skipped (no coords):  {skipped}")
    print(f"Failed FROM geocodes: {len(failed_from)}: {failed_from}")
    print(f"Failed TO geocodes:   {len(failed_to)}: {failed_to}")
    print(f"Out-of-bounds pts:    {len(out_of_bounds)}: {out_of_bounds}")
    print(f"Low-score points:     {len(low_score)}: {low_score}")
    print(f"\nOutput: {out_path}")

    # Save QA report
    qa_report = {
        "total_segments": total,
        "included": included,
        "skipped": skipped,
        "failed_from": failed_from,
        "failed_to": failed_to,
        "out_of_bounds": out_of_bounds,
        "low_score_points": low_score,
        "segment_flags": [
            {"id": r["id"], "road": r["road"], "qa_flag": r["qa_flag"]}
            for r in results if r["qa_flag"] != "OK"
        ],
    }
    qa_path = "/Users/pg/Documents/S/Lake_County_CMS/qa_report.json"
    with open(qa_path, "w") as f:
        json.dump(qa_report, f, indent=2)
    print(f"QA Report: {qa_path}")


if __name__ == "__main__":
    main()
